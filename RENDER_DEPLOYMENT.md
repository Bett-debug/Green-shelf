# Deploying Green Shelf to Render

This guide will walk you through deploying your Green Shelf application to Render.

## Prerequisites

- A [Render account](https://render.com) (free tier available)
- Your code pushed to a GitHub repository
- A Cohere API key for the AI chatbot functionality

## Deployment Steps

### 1. Prepare Your Repository

Ensure all the deployment files are committed to your repository:
- `render.yaml` - Infrastructure as Code configuration
- `build.sh` - Build script for deployment
- `requirements.txt` - Python dependencies (includes gunicorn and psycopg2-binary)
- `.env.example` - Example environment variables

### 2. Connect to Render

1. Log in to your [Render Dashboard](https://dashboard.render.com/)
2. Click **"New +"** and select **"Blueprint"**
3. Connect your GitHub account if you haven't already
4. Select the repository containing your Green Shelf application
5. Render will automatically detect the `render.yaml` file

### 3. Configure Environment Variables

Render will create the services defined in `render.yaml`. You need to set the following environment variable:

**For the Backend Service (greenshelf-backend):**

1. Go to your backend service in the Render dashboard
2. Navigate to **Environment** tab
3. Add the following environment variable:
   - `COHERE_API_KEY`: Your Cohere API key (get it from https://cohere.com)

**Note:** The following variables are automatically configured:
- `DATABASE_URL`: Automatically set by Render from the PostgreSQL database
- `JWT_SECRET_KEY`: Automatically generated by Render
- `PYTHON_VERSION`: Set to 3.11.0

### 4. Deploy

1. Click **"Apply"** to create the services
2. Render will:
   - Create a PostgreSQL database
   - Create a web service for your backend
   - Run the build script which:
     - Installs Python dependencies
     - Installs Node.js and builds the React frontend
     - Runs database migrations
   - Start your application with Gunicorn

### 5. Monitor Deployment

- Watch the build logs in the Render dashboard
- The first deployment may take 5-10 minutes
- Once complete, you'll see a URL like: `https://greenshelf-backend.onrender.com`

## Post-Deployment

### Access Your Application

Your application will be available at the URL provided by Render (e.g., `https://greenshelf-backend.onrender.com`)

### Database Migrations

Database migrations run automatically during deployment via the `build.sh` script. If you need to run migrations manually:

1. Go to your service in Render dashboard
2. Click **"Shell"** tab
3. Run: `flask db upgrade`

### Viewing Logs

To view application logs:
1. Go to your service in Render dashboard
2. Click **"Logs"** tab
3. View real-time logs or search historical logs

## Architecture

### Services Created

1. **PostgreSQL Database** (`greenshelf-db`)
   - Free tier PostgreSQL instance
   - Automatically backed up
   - Connection string provided to backend

2. **Backend Web Service** (`greenshelf-backend`)
   - Python/Flask application
   - Serves both API and React frontend
   - Runs on Gunicorn WSGI server
   - Auto-deploys on git push

### How It Works

1. **Build Process:**
   - `build.sh` installs Python dependencies
   - Installs Node.js via nvm
   - Builds React frontend to `client/dist`
   - Runs database migrations

2. **Runtime:**
   - Gunicorn serves the Flask application
   - Flask serves the React build from `client/dist`
   - API routes are available at `/api/*`
   - All other routes serve the React app

3. **Database:**
   - PostgreSQL in production
   - SQLite in local development
   - Automatic connection string handling

## Environment Variables Reference

| Variable | Description | Required | Auto-Generated |
|----------|-------------|----------|----------------|
| `DATABASE_URL` | PostgreSQL connection string | Yes | Yes (by Render) |
| `JWT_SECRET_KEY` | Secret key for JWT tokens | Yes | Yes (by Render) |
| `COHERE_API_KEY` | Cohere API key for AI features | Yes | No (you provide) |
| `PYTHON_VERSION` | Python version to use | Yes | Yes (set in render.yaml) |
| `FLASK_ENV` | Flask environment | No | No |
| `FRONTEND_URL` | Frontend URL for CORS | No | No |

## Troubleshooting

### Build Fails

**Issue:** Build script fails during npm install or build
- **Solution:** Check that `client/package.json` is valid and all dependencies are available

**Issue:** Database migration fails
- **Solution:** Check database connection and ensure migrations are in the `migrations/` directory

### Application Errors

**Issue:** 500 Internal Server Error
- **Solution:** Check logs in Render dashboard for Python errors
- Verify all environment variables are set correctly

**Issue:** Database connection errors
- **Solution:** Ensure `DATABASE_URL` is set and the database service is running

**Issue:** AI chatbot not working
- **Solution:** Verify `COHERE_API_KEY` is set correctly

### Performance Issues

**Issue:** Slow initial load (cold start)
- **Solution:** This is normal for free tier. Consider upgrading to a paid plan for always-on instances

## Updating Your Application

To deploy updates:

1. Push changes to your GitHub repository
2. Render automatically detects changes and redeploys
3. Monitor the deployment in the Render dashboard

## Local Development vs Production

### Local Development
- Uses SQLite database
- Frontend runs on Vite dev server (port 5173)
- Backend runs on Flask dev server (port 5000)
- CORS allows all origins

### Production (Render)
- Uses PostgreSQL database
- Frontend built and served by Flask
- Backend runs on Gunicorn
- CORS configured for production domain

## Cost

- **Free Tier:**
  - PostgreSQL: 90 days free, then $7/month
  - Web Service: Free (with limitations: spins down after inactivity)
  
- **Paid Plans:**
  - Start at $7/month for always-on instances
  - Better performance and no cold starts

## Security Best Practices

1. **Never commit `.env` file** - It's in `.gitignore`
2. **Use strong JWT secrets** - Auto-generated by Render
3. **Keep dependencies updated** - Regularly update `requirements.txt` and `package.json`
4. **Monitor logs** - Check for suspicious activity
5. **Use HTTPS** - Render provides SSL certificates automatically

## Support

- [Render Documentation](https://render.com/docs)
- [Render Community](https://community.render.com/)
- [Flask Documentation](https://flask.palletsprojects.com/)
- [React Documentation](https://react.dev/)

## Additional Resources

- **Render Blueprint Spec:** https://render.com/docs/blueprint-spec
- **Flask Deployment:** https://flask.palletsprojects.com/en/latest/deploying/
- **Gunicorn Configuration:** https://docs.gunicorn.org/en/stable/configure.html

---

**Note:** This deployment configuration uses Render's free tier, which is perfect for development and testing. For production applications with higher traffic, consider upgrading to a paid plan for better performance and reliability.